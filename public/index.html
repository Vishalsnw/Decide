<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Code Assistant</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0d1117;
            color: #e6edf3;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: #161b22;
            border-bottom: 1px solid #30363d;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 60px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 18px;
            font-weight: 600;
            color: #58a6ff;
        }

        .repo-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            justify-content: center;
        }

        .repo-badge {
            background: #238636;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            display: none;
        }

        .repo-badge.connected {
            display: block;
        }

        .import-btn {
            background: #238636;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.2s;
        }

        .import-btn:hover {
            background: #2ea043;
        }

        .import-btn:disabled {
            background: #484f58;
            cursor: not-allowed;
        }

        /* Repository List Modal */
        .repo-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .repo-modal.show {
            display: flex;
        }

        .repo-content {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            width: 100%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .repo-header {
            padding: 16px;
            border-bottom: 1px solid #30363d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .repo-title {
            font-size: 16px;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            color: #7d8590;
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
        }

        .repo-list {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .repo-item {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .repo-item:hover {
            border-color: #58a6ff;
        }

        .repo-name {
            font-weight: 600;
            color: #58a6ff;
            margin-bottom: 4px;
        }

        .repo-desc {
            font-size: 14px;
            color: #7d8590;
            margin-bottom: 8px;
        }

        .repo-lang {
            font-size: 12px;
            color: #56d364;
        }

        /* Chat Area */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .message.user {
            background: #1f6feb;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .message.assistant {
            background: #21262d;
            color: #e6edf3;
            border: 1px solid #30363d;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .message.system {
            background: #0969da;
            color: white;
            align-self: center;
            font-size: 13px;
            text-align: center;
            border-radius: 20px;
            padding: 8px 16px;
        }

        .welcome {
            text-align: center;
            padding: 40px 20px;
            color: #7d8590;
        }

        .welcome-icon {
            font-size: 48px;
            color: #58a6ff;
            margin-bottom: 16px;
        }

        .welcome h2 {
            color: #e6edf3;
            margin-bottom: 8px;
            font-size: 20px;
        }

        .welcome p {
            max-width: 400px;
            margin: 0 auto;
            line-height: 1.6;
        }

        /* Input Area */
        .input-area {
            border-top: 1px solid #30363d;
            padding: 16px;
            background: #161b22;
        }

        .input-container {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            max-width: 1000px;
            margin: 0 auto;
        }

        .input-box {
            flex: 1;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 12px;
            color: #e6edf3;
            font-size: 14px;
            resize: none;
            min-height: 44px;
            max-height: 120px;
            font-family: inherit;
        }

        .input-box:focus {
            outline: none;
            border-color: #1f6feb;
        }

        .input-box::placeholder {
            color: #7d8590;
        }

        .send-btn {
            background: #238636;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            min-width: 44px;
        }

        .send-btn:hover:not(:disabled) {
            background: #2ea043;
        }

        .send-btn:disabled {
            background: #484f58;
            cursor: not-allowed;
        }

        .typing {
            display: none;
            align-self: flex-start;
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 12px;
            border-bottom-left-radius: 4px;
            padding: 12px 16px;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #7d8590;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes pulse {
            0%, 60%, 100% { opacity: 0.4; }
            30% { opacity: 1; }
        }

        .loading {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 12px;
            }

            .logo {
                font-size: 16px;
            }

            .import-btn {
                font-size: 12px;
                padding: 6px 12px;
            }

            .messages {
                padding: 16px 12px;
            }

            .message {
                max-width: 90%;
                font-size: 14px;
            }

            .input-area {
                padding: 12px;
            }

            .input-container {
                gap: 8px;
            }

            .repo-modal {
                padding: 12px;
            }

            .repo-content {
                max-height: 90vh;
            }

            .welcome {
                padding: 20px 12px;
            }

            .welcome-icon {
                font-size: 36px;
            }
        }

        @media (max-width: 480px) {
            .repo-info {
                display: none;
            }

            .header {
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <i class="fas fa-robot"></i>
                AI Assistant
            </div>
            <div class="repo-info">
                <div class="repo-badge" id="repoBadge">No repository connected</div>
            </div>
            <button class="import-btn" id="importBtn">
                <i class="fab fa-github"></i>
                Import Repo
            </button>
        </div>

        <div class="chat-container">
            <div class="messages" id="messages">
                <div class="welcome">
                    <div class="welcome-icon">
                        <i class="fas fa-code"></i>
                    </div>
                    <h2>Welcome to AI Code Assistant</h2>
                    <p>Import a repository and start building with AI. Just describe what you want and I'll create, modify, or fix your code.</p>
                </div>
                <div class="typing" id="typing">
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            </div>

            <div class="input-area">
                <div class="input-container">
                    <textarea 
                        class="input-box" 
                        id="messageInput" 
                        placeholder="Describe what you want to build or modify..."
                        rows="1"
                    ></textarea>
                    <button class="send-btn" id="sendBtn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Repository Modal -->
    <div class="repo-modal" id="repoModal">
        <div class="repo-content">
            <div class="repo-header">
                <div class="repo-title">Select Repository</div>
                <button class="close-btn" id="closeModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="repo-list" id="repoList">
                <div style="text-align: center; padding: 20px; color: #7d8590;">
                    Loading repositories...
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedRepo = null;
        let sessionId = 'session_' + Date.now();

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            autoResizeTextarea();
        });

        function setupEventListeners() {
            // Import repository
            document.getElementById('importBtn').addEventListener('click', showRepoModal);

            // Close modal
            document.getElementById('closeModal').addEventListener('click', hideRepoModal);
            document.getElementById('repoModal').addEventListener('click', (e) => {
                if (e.target.id === 'repoModal') hideRepoModal();
            });

            // Send message
            document.getElementById('sendBtn').addEventListener('click', sendMessage);
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Auto-resize textarea
            document.getElementById('messageInput').addEventListener('input', autoResizeTextarea);
        }

        async function showRepoModal() {
            const modal = document.getElementById('repoModal');
            const btn = document.getElementById('importBtn');

            btn.disabled = true;
            btn.innerHTML = '<div class="loading"></div> Loading...';

            modal.classList.add('show');

            try {
                const response = await fetch('/api/github/repos');
                const data = await response.json();

                if (data.success) {
                    displayRepositories(data.repos);
                } else {
                    document.getElementById('repoList').innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #f85149;">
                            <i class="fas fa-exclamation-triangle"></i><br>
                            Failed to load repositories:<br>
                            <small>${data.error}</small>
                        </div>`;
                }
            } catch (error) {
                document.getElementById('repoList').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #f85149;">
                        <i class="fas fa-exclamation-triangle"></i><br>
                        Error: ${error.message}
                    </div>`;
            }

            btn.disabled = false;
            btn.innerHTML = '<i class="fab fa-github"></i> Import Repo';
        }

        function hideRepoModal() {
            document.getElementById('repoModal').classList.remove('show');
        }

        function displayRepositories(repos) {
            const container = document.getElementById('repoList');

            if (repos.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #7d8590;">
                        No repositories found
                    </div>`;
                return;
            }

            container.innerHTML = repos.map(repo => `
                <div class="repo-item" onclick="selectRepository(${JSON.stringify(repo).replace(/"/g, '&quot;')})">
                    <div class="repo-name">${repo.name}</div>
                    <div class="repo-desc">${repo.description || 'No description'}</div>
                    <div class="repo-lang">${repo.language || 'Unknown language'}</div>
                </div>
            `).join('');
        }

        function selectRepository(repo) {
            selectedRepo = repo;

            // Update UI
            const badge = document.getElementById('repoBadge');
            badge.textContent = repo.name;
            badge.classList.add('connected');

            hideRepoModal();

            // Clear welcome and add connection message
            const messages = document.getElementById('messages');
            messages.innerHTML = `
                <div class="message system">Connected to repository: ${repo.name}</div>
                <div class="message assistant">
                    Hi! I'm now connected to your repository "${repo.name}". 
                    I can help you create new files, modify existing code, add features, fix bugs, or build complete applications. 
                    Just describe what you want to do in plain English and I'll handle the coding and repository updates automatically.
                    <br><br>
                    What would you like to build or modify today?
                </div>
                <div class="typing" id="typing">
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message) return;

            // Add user message
            addMessage('user', message);
            input.value = '';
            autoResizeTextarea();

            // Show typing indicator
            showTyping();

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        selectedRepo: selectedRepo,
                        sessionId: sessionId
                    })
                });

                const data = await response.json();
                hideTyping();

                if (data.success) {
                    addMessage('assistant', data.response);

                    // If repo is connected and message suggests code changes, trigger auto-generation
                    if (selectedRepo && isCodeRequest(message)) {
                        addMessage('system', 'AI is working on your request...');
                        await handleCodeGeneration(message);
                    }
                } else {
                    addMessage('assistant', 'Sorry, I encountered an error: ' + data.error);
                }
            } catch (error) {
                hideTyping();
                addMessage('assistant', 'Sorry, I encountered an error: ' + error.message);
            }
        }

        function isCodeRequest(message) {
            const codeKeywords = ['create', 'add', 'build', 'make', 'write', 'generate', 'fix', 'modify', 'update', 'change', 'improve'];
            return codeKeywords.some(keyword => message.toLowerCase().includes(keyword));
        }

        async function handleCodeGeneration(instruction) {
            try {
                const response = await fetch('/api/repo/generate-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        owner: selectedRepo.full_name.split('/')[0],
                        repo: selectedRepo.name,
                        instruction: instruction,
                        language: 'javascript',
                        fileName: 'index.html'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    addMessage('system', `✅ Successfully created and committed ${data.fileName} to your repository`);
                    addMessage('assistant', `Perfect! I've created ${data.fileName} with the requested functionality and committed it directly to your repository. The changes are now live in your repo. You can view the commit or ask me to make further modifications.`);
                } else {
                    addMessage('system', `❌ Failed to create file: ${data.error}`);
                }
            } catch (error) {
                addMessage('system', `❌ Error: ${error.message}`);
            }
        }

        function addMessage(type, content) {
            const messages = document.getElementById('messages');
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.innerHTML = content.replace(/\n/g, '<br>');

            // Remove typing indicator before adding new message
            const typing = document.getElementById('typing');
            if (typing.parentNode) {
                typing.parentNode.removeChild(typing);
            }

            messages.appendChild(message);

            // Re-add typing indicator
            messages.appendChild(typing);

            messages.scrollTop = messages.scrollHeight;
        }

        function showTyping() {
            document.getElementById('typing').style.display = 'block';
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        }

        function hideTyping() {
            document.getElementById('typing').style.display = 'none';
        }

        function autoResizeTextarea() {
            const textarea = document.getElementById('messageInput');
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        // Expose selectRepository to global scope for onclick handlers
        window.selectRepository = selectRepository;
    </script>
</body>
</html>